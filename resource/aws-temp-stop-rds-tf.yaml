- name: Stop Aws RDS 
  hosts: localhost
  connection: local
  tasks:
    - name: stop aws rds instance by its ID
      amazon.aws.rds_instance:
        db_instance_identifier: "{{ identifier }}"
        region: "{{ (arn | split(':'))[3] }}"
        state: stopped
        wait: false
      poll: 0
        
    - name: gather information about the rds instance
      amazon.aws.rds_instance:
        region: "{{ (arn | split(':'))[3] }}"
        db_instance_identifier: "{{ identifier }}"
      register: result
      until: result.db_instance_status == 'stopped'
      retries: 20
      delay: 30
      loop_control:
        loop_var: gather_loop
        label: "Current status {{ result.db_instance_status }}"
      
    - name: Display logs
      debug:
        msg: "Attempt {{gather_loop.retry_num}}"
        verbosity: 3
      loop_control:
        label: "Checking..."
      
    - copy:
        content: "{{ result }}"
        dest: qtorque_outputs.json